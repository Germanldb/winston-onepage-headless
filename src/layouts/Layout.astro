---
import "../styles/global.css";

interface Props {
    title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="description"
            content="Winston & Harry - Calzado Artesanal de Lujo"
        />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/png" href="/favicon.png" />
        <link rel="preconnect" href="https://use.typekit.net" crossorigin />
        <link rel="dns-prefetch" href="https://winstonandharrystore.com" />
        <link rel="stylesheet" href="https://use.typekit.net/lpl0lgn.css" />

        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta
            property="og:url"
            content="https://winston-onepage-headless.vercel.app/"
        />
        <meta property="og:title" content={title} />
        <meta
            property="og:description"
            content="Winston & Harry - Calzado Artesanal de Lujo. Compra online ropa, maletas, zapatos de cuero colombianos para hombre."
        />
        <meta
            property="og:image"
            content="https://winston-onepage-headless.vercel.app/images/hero-poster.webp"
        />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta
            property="twitter:url"
            content="https://winston-onepage-headless.vercel.app/"
        />
        <meta property="twitter:title" content={title} />
        <meta
            property="twitter:description"
            content="Winston & Harry - Calzado Artesanal de Lujo. Compra online ropa, maletas, zapatos de cuero colombianos para hombre."
        />
        <meta
            property="twitter:image"
            content="https://winston-onepage-headless.vercel.app/images/hero-poster.webp"
        />
    </head>
    <body>
        <slot />

        <script>
            function initRevealOnScroll() {
                const observerOptions = {
                    threshold: 0.1,
                    rootMargin: "0px 0px -50px 0px",
                };

                // Use WeakSet to track processed elements WITHOUT touching their classList
                const processedElements = new WeakSet();

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add("is-visible");
                            observer.unobserve(entry.target);
                        }
                    });
                }, observerOptions);

                function observeNewElements() {
                    const elementsToReveal = document.querySelectorAll("img");

                    elementsToReveal.forEach((el) => {
                        // Skip already processed elements (no DOM modification needed)
                        if (processedElements.has(el)) return;
                        processedElements.add(el);

                        // *** CRITICAL: Never touch images inside React client components ***
                        // Astro wraps all client: components in <astro-island>.
                        // Modifying classList here causes React hydration mismatches.
                        if (el.closest("astro-island")) return;

                        // Skip images already visible
                        if (el.classList.contains("is-visible")) return;

                        // Only add reveal animation to static Astro images
                        el.classList.add("reveal-on-scroll");
                        observer.observe(el);
                    });
                }

                const mutationObserver = new MutationObserver(() => {
                    observeNewElements();
                });

                mutationObserver.observe(document.body, {
                    childList: true,
                    subtree: true,
                });

                observeNewElements();
            }

            document.addEventListener("astro:page-load", initRevealOnScroll);

            if (document.readyState === "loading") {
                document.addEventListener(
                    "DOMContentLoaded",
                    initRevealOnScroll,
                );
            } else {
                initRevealOnScroll();
            }
        </script>
    </body>
</html>
