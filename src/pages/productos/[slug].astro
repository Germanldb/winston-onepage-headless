---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProductDetail from "../../components/ProductDetail";
import { getProductBySlug } from "../../lib/woocommerce";

export const isr = {
    expiration: 86400, // 24 horas de caché
};

const { slug } = Astro.params;

/**
 * Función auxiliar para añadir .webp a las URLs de imágenes de WordPress de forma recursiva.
 */
function optimizeImages(data: any): any {
    if (!data) return data;
    if (Array.isArray(data)) return data.map(item => optimizeImages(item));
    if (typeof data === 'object') {
        const newData = { ...data };
        for (const key in newData) {
            if (key === 'src' && typeof newData[key] === 'string') {
                if (newData[key].includes('wp-content/uploads') && !newData[key].toLowerCase().endsWith('.webp')) {
                    let cleanSrc = newData[key].replace(/-e\d+(?=\.(jpg|jpeg|png))/i, '');
                    newData[key] = `${cleanSrc}.webp`;
                }
            } else {
                newData[key] = optimizeImages(newData[key]);
            }
        }
        return newData;
    }
    return data;
}

let product: any = null;
let error: any = null;

try {
    // 1. Fetch usando la nueva utilidad optimizada (REST API v3)
    product = await getProductBySlug(slug as string);
    
    if (product) {
        // --- FETCH RELATED PRODUCTS & FBT ---
        // Aquí podemos seguir usando el Store API para el listado masivo o migrar a v3 si es necesario.
        // Por ahora mantendremos la lógica de pool aleatorio para no sobrecargar la API REST.
        let relatedProducts = [];
        let fbtProducts: any[] = [];
        
        try {
            const shoeCats = [63, 64, 65, 66, 67, 68, 69, 70]; 
            const clothingCats = [951, 952, 251, 1022];        
            const accessoryCats = [250, 126, 172];             
            
            // Pool de productos para recomendaciones
            const res = await fetch(`https://winstonandharrystore.com/wp-json/wc/store/v1/products?per_page=60&orderby=date`);
            if (res.ok) {
                const relatedData = await res.json();
                
                const currentCats = product.categories?.map((c: any) => c.id) || [];
                const pName = product.name.toLowerCase();
                
                const isCurrentShoe = currentCats.some((id: any) => shoeCats.includes(id)) || 
                                      pName.includes('zapato') || pName.includes('mocasín') || pName.includes('tenis');
                
                const isCurrentClothing = currentCats.some((id: any) => clothingCats.includes(id)) || 
                                          pName.includes('chaqueta') || pName.includes('sueter') || pName.includes('suéter') || pName.includes('camisa');

                // 1. Completa tu look
                relatedProducts = relatedData
                    .filter((p: any) => p.id !== product.id)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 4);

                // 2. El Complemento Ideal (FBT)
                let poolA = relatedData.filter((p: any) => p.id !== product.id && (p.categories?.some((c: any) => shoeCats.includes(c.id))));
                let poolB = relatedData.filter((p: any) => p.id !== product.id && (p.categories?.some((c: any) => clothingCats.includes(c.id))));
                
                if (isCurrentShoe) {
                   fbtProducts = [poolB[0]].filter(Boolean);
                } else {
                   fbtProducts = [poolA[0]].filter(Boolean);
                }
            }
        } catch (e) {
            console.error("Error fetching related products:", e);
        }

        product.related_products = relatedProducts;
        product.fbt_products = fbtProducts.map(p => optimizeImages(p));

    } else {
        error = "Producto no encontrado en el catálogo";
    }
} catch (e) {
    console.error("Error crítico en [slug].astro:", e);
    error = "Hubo un problema de conexión.";
}

if (!product && !error) {
    return Astro.redirect("/404");
}
---

<Layout title={product ? `${product.name} | Winston & Harry` : "Producto"}>
    <Header />

    <main class="product-page-container">
        {
            product ? (
                <ProductDetail client:load initialProduct={product} />
            ) : (
                <div class="container error-msg">
                    <h1>{error}</h1>
                    <a href="/#tienda" class="btn">
                        Volver a la tienda
                    </a>
                </div>
            )
        }
    </main>

    <Footer />
</Layout>

<style>
    .product-page-container {
        padding-top: 90px;
        min-height: 80vh;
    }
    .error-msg {
        text-align: center;
        padding: 10rem 0;
    }
    h1 {
        margin-bottom: 2rem;
        color: var(--color-green);
    }

    @media (max-width: 768px) {
        .product-page-container {
            padding-top: 65px; /* Espacio para el header fixed */
            min-height: 80vh;
        }
</style>