---
// src/pages/productos/[slug].astro
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProductDetail from "../../components/ProductDetail";

export const isr = {
    expiration: 3600, // 1 hora de caché
};

const { slug } = Astro.params;

let product = null;
let error = null;

try {
    // 1. Fetch directo a WooCommerce (más seguro para ISR)
    const response = await fetch(
        `https://winstonandharrystore.com/wp-json/wc/store/v1/products?slug=${slug}`
    );
    
    if (response.ok) {
        const products = await response.json();
        if (products && products.length > 0) {
            // Buscamos el producto principal
            product = products.find((p: any) => p && p.attributes && p.attributes.length > 0) || products[0];

            // 2. ENRIQUECIMIENTO: Traer imágenes de variaciones (igual que en la API)
            if (product && product.type === 'variable' && product.variations) {
                const colorAttr = product.attributes.find((a: any) => a.name.toLowerCase().includes('color'));
                if (colorAttr && colorAttr.terms) {
                    const variationImages: any = {};
                    const colors = colorAttr.terms.map((t: any) => t.slug);

                    await Promise.all(colors.map(async (colorSlug: string) => {
                        const variation = product.variations.find((v: any) =>
                            v.attributes && v.attributes.some((attr: any) => attr.value.toLowerCase() === colorSlug.toLowerCase())
                        );

                        if (variation) {
                            try {
                                const varRes = await fetch(`https://winstonandharrystore.com/wp-json/wc/store/v1/products/${variation.id}`);
                                if (varRes.ok) {
                                    const varData = await varRes.json();
                                    if (varData.images && varData.images.length > 0) {
                                        variationImages[colorSlug] = varData.images;
                                    }
                                }
                            } catch (e) {
                                console.error(`Error fetch var ${variation.id}:`, e);
                            }
                        }
                    }));
                    product.variation_images_map = variationImages;
                }
            }
        } else {
            error = "Producto no encontrado";
        }
    } else {
        error = "Error al conectar con la tienda";
    }
} catch (e) {
    console.error("Error en [slug].astro:", e);
    error = "Error crítico al cargar el producto";
}

if (!product && !error) {
    return Astro.redirect("/404");
}
---

<Layout title={product ? `${product.name} | Winston & Harry` : "Producto"}>
    <Header />

    <main class="product-page-container">
        {
            product ? (
                <ProductDetail client:load initialProduct={product} />
            ) : (
                <div class="container error-msg">
                    <h1>{error}</h1>
                    <a href="/#tienda" class="btn">
                        Volver a la tienda
                    </a>
                </div>
            )
        }
    </main>

    <Footer />
</Layout>

<style>
    .product-page-container {
        padding-top: 90px;
        min-height: 80vh;
    }
    .error-msg {
        text-align: center;
        padding: 10rem 0;
    }
    h1 {
        margin-bottom: 2rem;
        color: var(--color-green);
    }

    @media (max-width: 768px) {
        .product-page-container {
            padding-top: 65px; /* Espacio para el header fixed */
            min-height: 80vh;
        }
</style>