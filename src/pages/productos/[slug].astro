---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProductDetail from "../../components/ProductDetail";

export const isr = {
    expiration: 3600, // Revalidar cada 60 minutos en segundo plano (SWR)
};

const { slug } = Astro.params;

// Fetch inicial en el servidor para SEO
let product = null;
let error = null;

try {
    const response = await fetch(
        `${Astro.url.origin}/api/products?slug=${slug}`,
    );
    if (response.ok) {
        product = await response.json();
    } else {
        error = "Producto no encontrado";
    }
} catch (e) {
    error = "Error al cargar el producto";
}

if (!product && !error) {
    return Astro.redirect("/404");
}
---

<Layout title={product ? `${product.name} | Winston & Harry` : "Producto"}>
    <Header />

    <main class="product-page-container">
        {
            product ? (
                <ProductDetail client:load initialProduct={product} />
            ) : (
                <div class="container error-msg">
                    <h1>{error}</h1>
                    <a href="/#tienda" class="btn">
                        Volver a la tienda
                    </a>
                </div>
            )
        }
    </main>

    <Footer />
</Layout>

<style>
    .product-page-container {
        padding-top: 90px; /* Espacio para el header fixed */
        min-height: 80vh;
    }

    .error-msg {
        text-align: center;
        padding: 10rem 0;
    }

    h1 {
        margin-bottom: 2rem;
        color: var(--color-green);
    }

    @media (max-width: 768px) {
        .product-page-container {
            padding-top: 65px; /* Espacio para el header fixed */
            min-height: 80vh;
        }
    }
</style>
