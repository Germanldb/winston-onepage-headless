---
interface Props {
    imageUrl: string;
    imageAlt?: string;
    title: string;
    description: string;
    pretitle?: string;
}

const { imageUrl, imageAlt = "", title, description, pretitle } = Astro.props;
---

<section class="lv-reveal-container" data-reveal-container>
    <div class="lv-reveal-sticky" data-reveal-sticky>
        <div class="lv-reveal-media">
            <img
                src={imageUrl}
                alt={imageAlt}
                class="lv-reveal-image"
                data-reveal-image
                loading="eager"
            />
            <div class="lv-reveal-overlay" data-reveal-overlay></div>
        </div>

        <div class="lv-reveal-content-wrapper">
            <div
                class="lv-reveal-content"
                data-reveal-content
                style="opacity: 0; transform: translateY(300px);"
            >
                {pretitle && <p class="lv-reveal-pretitle">{pretitle}</p>}
                <h3 class="lv-reveal-title">{title}</h3>
                <div class="lv-reveal-description">
                    <p>{description}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .lv-reveal-container {
        position: relative;
        /* Aumentamos a 400vh para dar tiempo al efecto parallax completo */
        height: 400vh;
        width: 100%;
        margin: 0;
        padding: 0;
        background-color: #000;
        /* Aseguramos que no haya overflow que rompa el sticky y z-index menor para que pase por detrás */
        z-index: 1;
    }

    .lv-reveal-sticky {
        position: sticky;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
    }

    .lv-reveal-media {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    .lv-reveal-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        display: block;
        transform-origin: center center;
        will-change: transform;
    }

    .lv-reveal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            to top,
            rgba(0, 0, 0, 0.7) 0%,
            rgba(0, 0, 0, 0.6) 40%,
            rgba(0, 0, 0, 0.4) 75%,
            rgba(0, 0, 0, 0.2) 90%
        );
        opacity: 0;
        z-index: 2;
        pointer-events: none;
        will-change: opacity;
    }

    .lv-reveal-content-wrapper {
        position: relative;
        z-index: 3;
        width: 100%;
        max-width: 900px;
        padding: 0 2rem;
        pointer-events: none;
    }

    .lv-reveal-content {
        text-align: center;
        color: #fff;
        will-change: transform, opacity;
    }

    .lv-reveal-pretitle {
        font-family: var(--font-titles);
        font-size: 0.9rem;
        letter-spacing: 5px;
        text-transform: uppercase;
        color: var(--color-beige);
        margin-bottom: 1.5rem;
    }

    .lv-reveal-title {
        font-family: var(--font-titles);
        font-size: clamp(
            1.5rem,
            5vw,
            2.5rem
        ); /* Reducido de 5rem a 2.5rem max */
        font-weight: 700;
        letter-spacing: 4px;
        line-height: 1.2;
        text-transform: uppercase;
        margin-bottom: 1.5rem;
        color: #fff;
    }

    .lv-reveal-description {
        font-family: var(--font-paragraphs);
        font-size: clamp(
            0.85rem,
            1.5vw,
            1rem
        ); /* Reducido de 1.3rem a 1rem max */
        line-height: 1.6;
        font-weight: 300;
        max-width: 500px;
        margin: 0 auto;
        color: rgba(255, 255, 255, 0.9);
    }
</style>

<script>
    function initLVReveal() {
        const containers = document.querySelectorAll("[data-reveal-container]");

        containers.forEach((container) => {
            const overlay = container.querySelector(
                "[data-reveal-overlay]",
            ) as HTMLElement;
            const content = container.querySelector(
                "[data-reveal-content]",
            ) as HTMLElement;
            const image = container.querySelector(
                "[data-reveal-image]",
            ) as HTMLElement;

            if (!overlay || !content) return;

            const updateEffect = () => {
                const rect = container.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                // Calculamos el progreso del scroll dentro del contenedor de 300vh
                // El efecto empieza cuando el contenedor llega arriba (rect.top <= 0)
                const scrollDist = -rect.top;
                const scrollableDist = rect.height - windowHeight;

                let progress = scrollDist / scrollableDist;
                progress = Math.max(0, Math.min(1, progress));

                // 1. Overlay Fade In (Desde el 5% al 70% del scroll)
                const overlayOpacity = Math.max(0, (progress - 0.05) / 0.65);
                overlay.style.opacity = Math.min(1, overlayOpacity).toString();

                // 2. Texto Sube (Desde el 15% al 90% del scroll)
                const contentProgress = Math.max(0, (progress - 0.15) / 0.75);
                const translateY =
                    300 - Math.min(1, contentProgress * 1.5) * 300;
                const contentOpacity = Math.min(1, contentProgress * 2.5);

                content.style.transform = `translateY(${translateY}px)`;
                content.style.opacity = Math.min(1, contentOpacity).toString();

                // 3. Zoom sutil (Scale 1.0 -> 1.1)
                // Empieza suave y aumenta con el scroll
                if (image) {
                    const scale = 1 + progress * 0.1;
                    image.style.transform = `scale(${scale})`;
                }
            };

            // Listener para scroll optimizado
            window.addEventListener("scroll", updateEffect, { passive: true });

            // Ejecución inicial
            updateEffect();
        });
    }

    // Compatibilidad con Astro view transitions y carga normal
    document.addEventListener("astro:page-load", initLVReveal);
    if (
        document.readyState === "complete" ||
        document.readyState === "interactive"
    ) {
        initLVReveal();
    } else {
        document.addEventListener("DOMContentLoaded", initLVReveal);
    }
</script>
